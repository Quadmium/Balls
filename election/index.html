<html>
<head>
	<style>
	html, body {
		margin: 0;
		padding: 0;
		background-image: url("new_year_background.png");
		background-repeat: repeat;
	}

	* {
		overflow-x: hidden;
	}

	::-webkit-scrollbar { 
    	display: none; 
	}

	#can {
		display: block;
		margin: auto;
	}

	</style>
	<title>Balls</title>
</head>

<body onload="init()">
	<canvas width=500 height=500 id="can"></canvas>
	<p>Hello!</p>
	<p>Click and drag to create a ball</p>
	<p>Press F to toggle friction</p>
	<p>Press C to clear</p>
</body>

<script src="util.js"></script>
<script src="primitives.js"></script>
<script src="collision.js"></script>

<script>

var worldObjects = [];
var mousePressed = false;
var drawingBall = false;
var friction = true;
var mu = 0.8;
var scale = 1;

var electionTrump = ["AL","9","AK","3","AZ","11","AR","6","GA","16","ID","4","IN","11","IA","6","KS","6","KY","8","LA","8","MS","6","MO","10","MT","3","NE","5","ND","3","OH","18","OK","7","SC","9","SD","3","TN","11","TX","38","UT","6","WV","5","WY","3"];

var electionHillary = ["CO","9","CT","7","DE","3","HI","4","ME","4","MD","10","MA","11","MI","16","MN","10","NV","6","NH","4","NJ","14","NM","5","NY","29","NC","15","PA","20","VT","3","OR","7","RI","4","FL","29","IL","20","VA","13","WA","12","WI","10","CA","55"];

var spawnIndex = 0;

function init()
{
	window.lastTime = new Date().getTime();
	window.g = new graphics();

	g.canvas.addEventListener('mousemove', function(evt) {
		window.mousePos = getMousePos(g.canvas, evt);
	}, false);

	g.canvas.addEventListener('mousedown', function(evt) {
		window.mouseClickPos = getMousePos(g.canvas, evt);
		window.mousePressed = true;
	}, false);

	g.canvas.addEventListener('mouseup', function(evt) {
		window.mousePressed = false;
	}, false);

	initWorld();

	onUpdate();
}

function initWorld()
{
	/*worldObjects.push(new pBall(70, new vector(250, 400)));
	worldObjects.push(new pBall(50, new vector(400, 400)));
	worldObjects[0].velocity = new vector(200, 0);
	worldObjects[0].mass = 70*70/50/50;
	worldObjects[0].color = "#550055";
	worldObjects[1].velocity = new vector(400, -50);
	worldObjects[0].color = "#555555";*/

	var cupWidth = 400;
	window.trumpColor = "#bc4d4d";
	window.hillaryColor = "#4d76bc";
	var leadWidth = 300;
	var leadRot = 30 * Math.PI / 180

	worldObjects.push(new pRect(50, 400, new vector(25+5,210), 0 * Math.PI / 180));
	worldObjects[0].color = hillaryColor;
	worldObjects.push(new pRect(50, 400, new vector(25+5 + cupWidth,210), 0 * Math.PI / 180));
	worldObjects[1].color = hillaryColor;
	worldObjects.push(new pRect(50, 400, new vector(g.width-(25+5),210), 0 * Math.PI / 180));
	worldObjects[2].color = trumpColor;
	worldObjects.push(new pRect(50, 400, new vector(g.width-(25+5 + cupWidth),210), 0 * Math.PI / 180));
	worldObjects[3].color = trumpColor;
	worldObjects.push(new pRect(cupWidth + 10, 50, new vector(25+5+cupWidth/2,35), 0 * Math.PI / 180));
	worldObjects[4].color = hillaryColor;
	worldObjects.push(new pRect(cupWidth + 10, 50, new vector(g.width-(25+5+cupWidth/2),35), 0 * Math.PI / 180));
	worldObjects[5].color = trumpColor;
	worldObjects.push(new pRect(leadWidth, 50, new vector(g.width/2 + leadWidth * Math.cos(leadRot) / 2,g.height - 200), 0 * Math.PI / 180));
	worldObjects[6].color = trumpColor;
	worldObjects[6].rotation = leadRot;
	worldObjects.push(new pRect(leadWidth, 50, new vector(g.width/2 - leadWidth * Math.cos(leadRot) / 2,g.height - 200), 0 * Math.PI / 180));
	worldObjects[7].color = hillaryColor;
	worldObjects[7].rotation = -leadRot;

	setTimeout(spawnBall, 1000);
}

function spawnBall()
{
	if(spawnIndex < electionTrump.length + electionHillary.length)
	{
		var list = spawnIndex % 2 == 0 ? electionTrump : electionHillary;
		var xPos = spawnIndex % 2 == 0 ? g.width / 2 + 20 : g.width / 2 - 20;

		worldObjects.push(new pBall(Math.sqrt(parseInt(list[Math.floor(spawnIndex/2) * 2 + 1])) * 10,new vector(xPos + Math.random() * 5, g.height)));
		worldObjects[worldObjects.length-1].text = list[Math.floor(spawnIndex/2) * 2];
		worldObjects[worldObjects.length - 1].color = spawnIndex % 2 == 0 ? trumpColor.replace("4","9") : hillaryColor.replace("4","9");

		spawnIndex++;
		setTimeout(spawnBall, 1000);
	}

	/*
	worldObjects.push(new pBall(Math.floor(Math.random()*70),new vector(600, 200)));
	worldObjects[worldObjects.length-1].text = "hi";
	*/
}

function onUpdate()
{
	window.deltaTime = (new Date().getTime() - window.lastTime) / 1000;
	window.lastTime = new Date().getTime();

	if(window.innerHeight / window.innerWidth < g.height / g.width)
	{
		g.canvas.width = g.width / g.height * g.canvas.height;
		g.canvas.height = window.innerHeight;
		scale = g.canvas.height / g.height;
	}
	else
	{
		g.canvas.height = g.height / g.width * g.canvas.width;
		g.canvas.width = window.innerWidth;
		scale = g.canvas.width / g.width;
	}

	for(var i=0; i < worldObjects.length; i++)
	{
		var curObj = worldObjects[i];

		for(var j=i+1; j < worldObjects.length; j++)
			handleCollision(curObj, worldObjects[j]);

		if(curObj.onUpdate != undefined)
			curObj.onUpdate(deltaTime);
	}
	
	//g.ctx.fillStyle="#FFFFFF";
	//g.ctx.fillRect(0, 0, g.canvas.width, g.canvas.height);
	g.ctx.clearRect(0, 0, g.canvas.width, g.canvas.height);

	for(var i=0; i < worldObjects.length; i++)
	{
		var curObj = worldObjects[i];
		
		if(curObj.onDraw != undefined)
			curObj.onDraw(g);
	}

	//handleInput();

	setTimeout(onUpdate, 1);
}

function handleInput()
{
	if(mousePressed || drawingBall)
	{
		window.drawingBall = true;
		var radius = mousePos.sub(mouseClickPos).mag();

		var clr = Math.floor(radius) % 360;
		g.ctx.fillStyle = "hsl(" + clr + ", 100%, 50%)";
		g.ctx.beginPath();
		g.ctx.arc(mouseClickPos.x, mouseClickPos.y, radius, 0, 2 * Math.PI);
		g.ctx.fill();
		g.ctx.closePath();
	} 
	
	if(!mousePressed && drawingBall)
	{
		drawingBall = false;
		var adjPos = mouseClickPos.clone();
		adjPos.y = g.canvas.height - adjPos.y;
		var b = new pBall(mousePos.sub(mouseClickPos).mag(), adjPos);
		b.mass = b.radius * b.radius / 50 / 50;

		var clr = Math.floor(b.radius) % 360;
		b.color = "hsl(" + clr + ", 100%, 50%)";

		worldObjects.push(b);
	}
}

function getMousePos(canvas, evt) 
{
	var rect = canvas.getBoundingClientRect();
	return new vector(evt.clientX - rect.left, evt.clientY - rect.top);
}

document.onkeydown = checkKey;

function checkKey(e) 
{

    e = e || window.event;

    if (e.keyCode == '70')
    	friction = !friction;
    if (e.keyCode == '67')
    	worldObjects.length = 0;
}

</script>
</html>
